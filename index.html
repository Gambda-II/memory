class Game {
    numberOfCardsHorizontal = 6;
    numberOfCardsVertical = 3;

    numberOfCards;

    flippedCards = 0;
    openCards = [];

    #numberOfMatches = 0;
    #numberOfTries = 0;


    backImageSources = ['./assets/images/backCard1.jpg'];
    backImagesResources = [];
    frontImagesSources = ['./assets/images/crescent.jpg', './assets/images/flowers.jpg', './assets/images/fox.jpg', './assets/images/glassBouqet.jpg', './assets/images/pancake.jpg', './assets/images/penguin.jpg', './assets/images/pyjamaCat.jpg', './assets/images/robot.jpg', './assets/images/butterfly.jpg', './assets/images/castle.jpg', './assets/images/tower.jpg', './assets/images/coolCat.jpg', './assets/images/unicorn.jpg'];
    frontImageResources = [];
    cards;

    constructor() {
        this.numberOfCards = this.numberOfCardsHorizontal * this.numberOfCardsVertical;
        this.cards = [];

        this.setBacksideImageResource();
        this.setFrontsideImageResource();

        this.initCards();
        this.shuffleCards();
    }

    shuffleCards() {

        let parent = document.querySelector('Gameboard');
        for (var i = parent.children.length; i >= 0; i--) {
            parent.appendChild(parent.children[Math.random() * i | 0]);
        }

    }

    initCards() {
        let index = 0;
        while (index < this.numberOfCards) {

            this.addPairOfCards(index);
            index += 2;
        }
    }

    addPairOfCards(index) {

        let firstIndex = index, secondIndex = index + 1;
        let value = index;

        let frontImage = this.frontImageResources[index];
        let backImage = this.backImagesResources[0];

        this.cards.push(new Card(firstIndex, value, frontImage, backImage));
        this.cards.push(new Card(secondIndex, value, frontImage, backImage));

        this.addToHTML(index);
    }

    flip(card){
        let array = Array.from(card.children);
        array.forEach(child => {
            console.log(this.flippedCards);
            console.log(this.openCards[0]);
            console.log(this.openCards[1]);
            console.log(this.openCards.length);

            if (this.openCards.length < 2){
                
                if (child.alt=='hidden'){
                    child.alt = 'visible';
                    child.style.visibility = child.alt;
                    this.flippedCards++;
                }
                else if (child.alt=='visible'){
                    child.alt = 'hidden';
                    child.style.visibility = child.alt;
                    this.flippedCards++;
                }
                this.openCards.push(card);
            }
            else {
                let firstValue = this.openCards[0].name;
                let secondValue = this.openCards[1].name;
                
                if (firstValue != secondValue){
                    this.openCards.pop;
                    this.openCards.pop;

                }
                else {
                    
                }
                
                this.flippedCards = 0;
                return;
            }

            
        });
    }

    addToHTML(index) {
        const container = document.getElementById('card-container');

        let firstCard = document.createElement('button');
        let secondCard = document.createElement('button');

        firstCard.className = "memory-card";
        secondCard.className = "memory-card";

        firstCard.id = `card-id-${index}`;
        secondCard.id = `card-id-${index + 1}`;

        firstCard.name = index;
        secondCard.name = index;

        firstCard.value = 0.0;
        secondCard.value = 0.0;
        
        firstCard.addEventListener('mousedown', () => { firstCard.style.transform = `rotateY(${firstCard.value}deg)`; firstCard.value = (Number.parseInt(firstCard.value) + 180) % 360; this.flip(firstCard);firstCard.style.transform = `rotateY(${firstCard.value}deg)`; firstCard.value = (Number.parseInt(firstCard.value) + 180) % 360;});
        /*
        secondCard.addEventListener('mousedown', () => { secondCard.style.transform = `rotateY(${secondCard.value}deg)`; secondCard.value = (Number.parseInt(secondCard.value) + 180) % 360; this.flip(secondCard)})
        */
        secondCard.addEventListener('mousedown', () => { secondCard.style.transform = `rotateY(${secondCard.value}deg)`; secondCard.value = (Number.parseInt(secondCard.value) + 180) % 360; this.flip(secondCard);secondCard.style.transform = `rotateY(${secondCard.value}deg)`; secondCard.value = (Number.parseInt(secondCard.value) + 180) % 360;});


        let firstImage = document.createElement('img');
        firstImage.id = `image-${index}`;
        firstImage.src = this.frontImagesSources[index / 2];
        firstImage.alt = 'hidden';
        firstImage.style.visibility = firstImage.alt;

        let secondImage = document.createElement('img');
        secondImage.id = `image-${index+1}`;
        secondImage.src = this.frontImagesSources[index / 2];
        secondImage.alt = 'hidden';
        secondImage.style.visibility = secondImage.alt;

        let backImage = document.createElement('img');
        backImage.id = 'image-bg-0';
        backImage.src = this.backImageSources[0];
        backImage.style.transform = 'translate(0%,-97%)';
        backImage.alt = 'visible';
        

        let secondBackImage = document.createElement('img');
        secondBackImage.id = 'image-bg-1';
        secondBackImage.src = this.backImageSources[0];
        secondBackImage.style.transform = 'translate(0%,-97%)';
        secondBackImage.alt = 'visible';

        container.appendChild(firstCard);
        container.appendChild(secondCard);

        firstCard.appendChild(firstImage);
        secondCard.appendChild(secondImage);

        firstCard.appendChild(backImage);
        secondCard.appendChild(secondBackImage);

    }



    loadImage(url) {
        let image = new Image();
        image.src = url;

        image.onload = function () {
            return image;
        }

        image.onerror = function () {
            return null;
        }
    }

    /*
    loadImage(url) {
        return new Promise(
            (resolve,reject) => {
                let image = new Image();
                image.src = url;
                
                image.onload = function() {
                    resolve(image);
                }
                
                image.onerror = function () {
                    reject(new Error('Failed to load image'));
                }
            }
            
            );
        }
        */

    async setBacksideImageResource() {
        let urls = this.backImageSources;

        for (let i = 0; i < urls.length; i++) {

            let url = urls[i];

            try {
                let image = await this.loadImage(url);
                this.backImagesResources.push = image;
            } catch (error) {
                console.error(error);
            }
        }
    }

    async setFrontsideImageResource() {
        let urls = this.frontImagesSources;

        for (let i = 0; i < urls.length; i++) {

            let url = urls[i];

            try {
                let image = await this.loadImage(url);
                this.frontImageResources.push = image;
            } catch (error) {
                console.error(error);
            }
        }
    }
}

class Card {
    id;
    value;

    #backSideImage;
    #frontSideImage;

    #isFaceUp = false;
    #isMatched = false;

    constructor(id, value, frontImage, backImage) {
        this.id = id;
        this.value = value;

        this.#frontSideImage = frontImage;
        this.#backSideImage = backImage;
    }

    flipCard() {
        flipCardAnimation();
        this.#isFaceUp = !this.#isFaceUp;
    }

    flipCardAnimation() {
    }
}

let game = new Game();